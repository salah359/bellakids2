<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù…Ø¯ÙŠØ± Ø§Ù„Ù…ØªØ¬Ø± | Ø¨ÙŠÙ„Ø§ ÙƒÙŠØ¯Ø²</title>
    
    <script>
        const token = localStorage.getItem('adminToken');
        if (!token) {
            window.location.href = 'admin-login.html';
        }
    </script>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.rtl.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Cairo', sans-serif; background-color: #f4f7f6; }
        .admin-card { border: none; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.05); }
        .product-img { width: 50px; height: 50px; object-fit: cover; border-radius: 8px; }
        .navbar { background: #2d3436; }
        .preview-thumb { width: 60px; height: 60px; object-fit: cover; border-radius: 8px; border: 1px solid #ddd; }
        
        /* Fix Table alignment in RTL */
        th, td { text-align: right; }
    </style>
</head>
<body>

    <nav class="navbar navbar-dark shadow-sm mb-4">
        <div class="container">
            <span class="navbar-brand fw-bold">ğŸŒ¸ Ù…Ø¯ÙŠØ± Ø¨ÙŠÙ„Ø§ ÙƒÙŠØ¯Ø²</span>
            <div class="d-flex gap-2">
                <a href="index.html" class="btn btn-outline-light btn-sm rounded-pill" target="_blank">Ø¹Ø±Ø¶ Ø§Ù„Ù…ØªØ¬Ø±</a>
                <button class="btn btn-danger btn-sm rounded-pill" onclick="handleLogout()">ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</button>
            </div>
        </div>
    </nav>

    <div class="container pb-5">
        <div class="row mb-4 align-items-center">
            <div class="col-md-6">
                <h2 class="fw-bold m-0">Ø§Ù„Ù…Ø®Ø²ÙˆÙ† ÙˆØ§Ù„Ù…Ù†ØªØ¬Ø§Øª</h2>
                <p class="text-muted small">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù„ØºØ§ØªØŒ Ø§Ù„ØµÙˆØ±ØŒ ÙˆØ§Ù„Ø£Ø³Ø¹Ø§Ø±.</p>
            </div>
            <div class="col-md-6 text-md-end">
                <button class="btn btn-primary rounded-pill px-4 fw-bold shadow-sm" onclick="openAddModal()">
                    + Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬ Ø¬Ø¯ÙŠØ¯
                </button>
            </div>
        </div>

        <div class="card admin-card overflow-hidden">
            <div class="table-responsive">
                <table class="table table-hover align-middle mb-0">
                    <thead class="table-light">
                        <tr>
                            <th class="pe-4">Ø§Ù„ØµÙˆØ±Ø©</th>
                            <th>Ø§Ù„Ø§Ø³Ù…</th>
                            <th>Ø§Ù„Ø³Ø¹Ø±</th>
                            <th>Ø§Ù„Ù‚Ø³Ù…</th>
                            <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                            <th class="text-end ps-4">Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                        </tr>
                    </thead>
                    <tbody id="inventoryList">
                        </tbody>
                </table>
            </div>
        </div>
    </div>

    <div class="modal fade" id="productModal" tabindex="-1">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content border-0 rounded-4 shadow-lg">
                <form id="productForm">
                    <div class="modal-header bg-light border-0 py-3">
                        <h5 class="modal-title fw-bold" id="modalTitle">Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" style="margin-left: 0; margin-right: auto;"></button>
                    </div>
                    
                    <div class="modal-body p-4">
                        <div class="row g-3">
                            
                            <input type="hidden" name="name_en" value="">

                            <div class="col-md-12">
                                <label class="form-label small fw-bold text-success">Ø§Ù„Ø§Ø³Ù… (Ø¹Ø±Ø¨ÙŠ)</label>
                                <input type="text" name="name_ar" class="form-control rounded-3" placeholder="Ù…Ø«Ù„Ø§Ù‹: ÙØ³ØªØ§Ù† ØµÙŠÙÙŠ" required>
                            </div>

                            <div class="col-md-4">
                                <label class="form-label small fw-bold">Ø§Ù„Ø³Ø¹Ø± (â‚ª)</label>
                                <input type="number" step="0.01" name="price" class="form-control rounded-3" required>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label small fw-bold">Ø§Ù„Ù‚Ø³Ù…</label>
                                <select name="category" class="form-select rounded-3">
                                    <option value="boys">Ø£ÙˆÙ„Ø§Ø¯</option>
                                    <option value="girls">Ø¨Ù†Ø§Øª</option>
                                    <option value="newborn">Ù…ÙˆØ§Ù„ÙŠØ¯</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label small fw-bold">Ø­Ø§Ù„Ø© Ø§Ù„ØªÙˆÙØ±</label>
                                <select name="inStock" class="form-select rounded-3">
                                    <option value="true">âœ… Ù…ØªÙˆÙØ±</option>
                                    <option value="false">âŒ Ù†ÙØ¯ Ø§Ù„ÙƒÙ…ÙŠØ©</option>
                                </select>
                            </div>

                            <div class="col-12">
                                <label class="form-label small fw-bold">Ø§Ù„Ù…Ù‚Ø§Ø³Ø§Øª (Ø§ÙØµÙ„ Ø¨ÙŠÙ†Ù‡Ø§ Ø¨ÙØ§ØµÙ„Ø©)</label>
                                <input type="text" name="sizes" class="form-control rounded-3" placeholder="Ù…Ø«Ù„Ø§Ù‹: 2Y, 3Y, 4Y, S, M" dir="ltr" required>
                            </div>

                            <textarea name="description_en" class="d-none"></textarea>

                            <div class="col-md-12">
                                <label class="form-label small fw-bold text-muted">Ø§Ù„ÙˆØµÙ (Ø¹Ø±Ø¨ÙŠ)</label>
                                <textarea name="description_ar" class="form-control rounded-3" rows="3"></textarea>
                            </div>

                            <div class="col-12">
                                <div class="p-3 bg-light rounded-3 border dashed-border">
                                    <label class="form-label small fw-bold d-block">ğŸ“¸ Ø±ÙØ¹ Ø§Ù„ØµÙˆØ± (Ø­Ø¯ Ø£Ù‚ØµÙ‰ 5)</label>
                                    <input type="file" name="images" id="imageFiles" class="form-control" multiple accept="image/*">
                                    <div id="previewContainer" class="d-flex gap-2 mt-3 flex-wrap"></div>
                                </div>
                            </div>

                        </div>
                    </div>

                    <div class="modal-footer bg-light border-0">
                        <button type="button" class="btn btn-secondary rounded-pill px-4" data-bs-dismiss="modal">Ø¥Ù„ØºØ§Ø¡</button>
                        <button type="submit" class="btn btn-primary rounded-pill px-5 fw-bold" id="saveBtn">Ø­ÙØ¸ Ø§Ù„Ù…Ù†ØªØ¬</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        const API_URL = '/api/products';
        const modal = new bootstrap.Modal(document.getElementById('productModal'));
        const ADMIN_TOKEN = localStorage.getItem('adminToken');
        
        let allProducts = [];

        // 1. Initial Load
        fetchInventory();

        function handleLogout() {
            localStorage.removeItem('adminToken');
            window.location.href = 'admin-login.html';
        }

        // 2. Fetch Data
        async function fetchInventory() {
            try {
                const res = await fetch(API_URL);
                if (!res.ok) throw new Error('Failed to fetch');
                allProducts = await res.json();
                renderInventory(allProducts);
            } catch (err) {
                console.error(err);
                document.getElementById('inventoryList').innerHTML = 
                    `<tr><td colspan="6" class="text-center text-danger py-4">âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…</td></tr>`;
            }
        }

        // 3. Render Table
        function renderInventory(products) {
            const tbody = document.getElementById('inventoryList');
            if(products.length === 0) {
                tbody.innerHTML = `<tr><td colspan="6" class="text-center py-5 text-muted"><h4>ğŸ“­ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© ÙØ§Ø±ØºØ©</h4><p>Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ <b>+ Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬ Ø¬Ø¯ÙŠØ¯</b> Ù„Ù„Ø¨Ø¯Ø¡!</p></td></tr>`;
                return;
            }

            const categoryMap = {
                'boys': 'Ø£ÙˆÙ„Ø§Ø¯',
                'girls': 'Ø¨Ù†Ø§Øª',
                'newborn': 'Ù…ÙˆØ§Ù„ÙŠØ¯',
                'all': 'Ø§Ù„ÙƒÙ„'
            };

            tbody.innerHTML = products.map(p => {
                let imgPath = 'assets/images/placeholder.png';
                if(p.images && p.images.length > 0) {
                    imgPath = p.images[0].startsWith('http') ? p.images[0] : `/uploads/${p.images[0]}`;
                }

                const stockBadge = p.inStock 
                    ? '<span class="badge bg-success bg-opacity-75">Ù…ØªÙˆÙØ±</span>' 
                    : '<span class="badge bg-danger bg-opacity-75">Ù†ÙØ¯ Ø§Ù„ÙƒÙ…ÙŠØ©</span>';

                const catName = categoryMap[p.category] || p.category;

                return `
                <tr>
                    <td class="pe-4"><img src="${imgPath}" class="product-img shadow-sm"></td>
                    <td>
                        <div class="fw-bold text-dark">${p.name_ar || '-'}</div>
                    </td>
                    <td class="fw-bold text-primary">â‚ª${p.price}</td>
                    <td><span class="badge bg-light text-dark border">${catName}</span></td>
                    <td>${stockBadge}</td>
                    <td class="text-end ps-4">
                        <button onclick="deleteProduct('${p._id}')" class="btn btn-sm btn-outline-danger px-3 rounded-pill">Ø­Ø°Ù</button>
                    </td>
                </tr>
            `}).join('');
        }

        // 4. Handle Form Submit
        document.getElementById('productForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = document.getElementById('saveBtn');
            const originalText = btn.innerText;
            
            btn.innerText = "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø±ÙØ¹...";
            btn.disabled = true;

            const formData = new FormData(e.target);
            
            // Auto-fill English fields with Arabic content if backend requires them, or just send empty string
            // This prevents backend validation errors if 'name_en' is required
            if (!formData.get('name_en')) {
                formData.set('name_en', formData.get('name_ar')); 
            }
             if (!formData.get('description_en')) {
                formData.set('description_en', formData.get('description_ar')); 
            }

            try {
                const res = await fetch(API_URL, { 
                    method: 'POST', 
                    headers: { 'Authorization': ADMIN_TOKEN },
                    body: formData 
                });
                
                if (res.ok) {
                    modal.hide();
                    e.target.reset();
                    document.getElementById('previewContainer').innerHTML = '';
                    fetchInventory();
                } else {
                    alert("Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ù…Ù†ØªØ¬. ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø®Ø§Ø¯Ù….");
                }
            } catch (err) {
                alert("ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù….");
            } finally {
                btn.innerText = originalText;
                btn.disabled = false;
            }
        });

        // 5. Delete Function
        async function deleteProduct(id) {
            if (!confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ø£Ù†Ùƒ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù…Ù†ØªØ¬ØŸ")) return;
            try {
                const res = await fetch(`${API_URL}/${id}`, { 
                    method: 'DELETE',
                    headers: { 'Authorization': ADMIN_TOKEN }
                });
                if (res.ok) {
                    fetchInventory();
                } else {
                    alert("ÙØ´Ù„ Ø§Ù„Ø­Ø°Ù. ØµÙ„Ø§Ø­ÙŠØ§Øª ØºÙŠØ± ÙƒØ§ÙÙŠØ©ØŸ");
                }
            } catch(e) { alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­Ø°Ù"); }
        }

        // 6. UI Helpers
        function openAddModal() {
            document.getElementById('productForm').reset();
            document.getElementById('previewContainer').innerHTML = '';
            modal.show();
        }

        document.getElementById('imageFiles').addEventListener('change', function(e) {
            const container = document.getElementById('previewContainer');
            container.innerHTML = '';
            Array.from(e.target.files).forEach(file => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const img = document.createElement('img');
                    img.src = e.target.result;
                    img.className = 'preview-thumb';
                    container.appendChild(img);
                }
                reader.readAsDataURL(file);
            });
        });
    </script>
</body>
</html>