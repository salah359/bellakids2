<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù…Ø¯ÙŠØ± Ø§Ù„Ù…ØªØ¬Ø± | Ø¨ÙŠÙ„Ø§ ÙƒÙŠØ¯Ø²</title>
    

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.rtl.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Cairo', sans-serif; background-color: #f4f7f6; }
        .admin-card { border: none; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.05); }
        .product-img { width: 50px; height: 50px; object-fit: cover; border-radius: 8px; }
        .navbar { background: #2d3436; }
        .preview-wrapper { position: relative; width: 100px; text-align: center; }
        .preview-thumb { width: 100px; height: 100px; object-fit: cover; border-radius: 8px; border: 1px solid #ddd; }
        th, td { text-align: right; vertical-align: middle; }
    </style>
</head>
<body>

    <nav class="navbar navbar-dark shadow-sm mb-4">
        <div class="container">
            <span class="navbar-brand fw-bold">ğŸŒ¸ Ù…Ø¯ÙŠØ± Ø¨ÙŠÙ„Ø§ ÙƒÙŠØ¯Ø²</span>
            <div class="d-flex gap-2">
                <a href="index.html" class="btn btn-outline-light btn-sm rounded-pill" target="_blank">Ø¹Ø±Ø¶ Ø§Ù„Ù…ØªØ¬Ø±</a>
                <button class="btn btn-danger btn-sm rounded-pill" onclick="handleLogout()">ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</button>
            </div>
        </div>
    </nav>

    <div class="container pb-5">
        <div class="row mb-4 align-items-center">
            <div class="col-md-6">
                <h2 class="fw-bold m-0">Ø§Ù„Ù…Ø®Ø²ÙˆÙ† ÙˆØ§Ù„Ù…Ù†ØªØ¬Ø§Øª</h2>
                <p class="text-muted small">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ù„ÙˆØ§Ù†ØŒ Ø§Ù„Ù…Ù‚Ø§Ø³Ø§ØªØŒ ÙˆØ§Ù„Ø£Ø³Ø¹Ø§Ø±.</p>
            </div>
            <div class="col-md-6 text-md-end">
                <button class="btn btn-primary rounded-pill px-4 fw-bold shadow-sm" onclick="openAddModal()">
                    + Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬ Ø¬Ø¯ÙŠØ¯
                </button>
            </div>
        </div>

        <div class="card admin-card overflow-hidden">
            <div class="table-responsive">
                <table class="table table-hover align-middle mb-0">
                    <thead class="table-light">
                        <tr>
                            <th class="pe-4">Ø§Ù„ØµÙˆØ±Ø©</th>
                            <th>ID</th>
                            <th>Ø§Ù„Ø§Ø³Ù…</th>
                            <th>Ø§Ù„Ø³Ø¹Ø±</th>
                            <th>Ø§Ù„Ù‚Ø³Ù… / Ø§Ù„Ù†ÙˆØ¹</th>
                            <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                            <th class="text-end ps-4">Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                        </tr>
                    </thead>
                    <tbody id="inventoryList"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div class="modal fade" id="productModal" tabindex="-1">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content border-0 rounded-4 shadow-lg">
                <form id="productForm">
                    <div class="modal-header bg-light border-0 py-3">
                        <h5 class="modal-title fw-bold" id="modalTitle">Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" style="margin-left: 0; margin-right: auto;"></button>
                    </div>
                    
                    <div class="modal-body p-4">
                        <input type="hidden" id="editId" name="id"> 
                        <div class="row g-3">
                            <input type="hidden" name="name_en" id="name_en">
                            
                            <div class="col-md-8">
                                <label class="form-label small fw-bold text-success">Ø§Ù„Ø§Ø³Ù… (Ø¹Ø±Ø¨ÙŠ)</label>
                                <input type="text" name="name_ar" id="name_ar" class="form-control rounded-3" required>
                            </div>

                            <div class="col-md-4">
                                <label class="form-label small fw-bold">ID Ø§Ù„Ù…Ù†ØªØ¬ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
                                <input type="text" name="itemId" id="itemId" class="form-control rounded-3" placeholder="Ù…Ø«Ù„Ø§Ù‹: BK-101">
                            </div>

                            <div class="col-md-6">
                                <label class="form-label small fw-bold">Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ (â‚ª)</label>
                                <input type="number" step="0.01" name="price" id="price" class="form-control rounded-3" required>
                            </div>
                            
                            <div class="col-md-6">
                                <label class="form-label small fw-bold text-danger">Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ù‚Ø¯ÙŠÙ… (Ù„Ù„Ø¹Ø±ÙˆØ¶)</label>
                                <input type="number" step="0.01" name="oldPrice" id="oldPrice" class="form-control rounded-3" placeholder="Ø§Ø®ØªÙŠØ§Ø±ÙŠ">
                            </div>

                            <div class="col-md-6">
                                <label class="form-label small fw-bold">Ø§Ù„Ù‚Ø³Ù…</label>
                                <select name="category" id="category" class="form-select rounded-3">
                                    <option value="boys">Ø£ÙˆÙ„Ø§Ø¯</option>
                                    <option value="girls">Ø¨Ù†Ø§Øª</option>
                                    <option value="newborn">Ù…ÙˆØ§Ù„ÙŠØ¯</option>
                                    <option value="all">Ø§Ù„ÙƒÙ„</option>
                                </select>
                            </div>

                            <div class="col-md-6">
                                <label class="form-label small fw-bold">Ù†ÙˆØ¹ Ø§Ù„Ù…Ù†ØªØ¬ (ÙÙ„ØªØ±)</label>
                                <select name="subCategory" id="subCategory" class="form-select rounded-3">
                                    <option value="pajamas">Pajamas (Ø¨ÙŠØ¬Ø§Ù…Ø§Øª)</option>
                                    <option value="sportswear">Sportswear (Ø±ÙŠØ§Ø¶ÙŠ)</option>
                                    <option value="formal">Sportswear and formal wear (Ø±Ø³Ù…ÙŠ)</option>
                                    <option value="overalls">Overalls (Ø£ÙØ±Ù‡ÙˆÙ„Ø§Øª)</option>
                                    <option value="pants">Pants (Ø¨Ù†Ø§Ø·ÙŠÙ„)</option>
                                    <option value="shirts">Shirts and blouses (Ù‚Ù…ØµØ§Ù†)</option>
                                    <option value="dresses">Skirts and dresses (ÙØ³Ø§ØªÙŠÙ†)</option>
                                    <option value="shoes">Shoes (Ø£Ø­Ø°ÙŠØ©)</option>
                                    <option value="bags">Bags (Ø­Ù‚Ø§Ø¦Ø¨)</option>
                                    <option value="other">Other (ØºÙŠØ± Ø°Ù„Ùƒ)</option>
                                </select>
                            </div>

                            <div class="col-md-6">
                                <label class="form-label small fw-bold">Ø­Ø§Ù„Ø© Ø§Ù„ØªÙˆÙØ±</label>
                                <select name="inStock" id="inStock" class="form-select rounded-3">
                                    <option value="true">âœ… Ù…ØªÙˆÙØ±</option>
                                    <option value="false">âŒ Ù†ÙØ¯ Ø§Ù„ÙƒÙ…ÙŠØ©</option>
                                </select>
                            </div>

                            <div class="col-md-6">
                                <label class="form-label small fw-bold">Ø§Ù„Ù…Ù‚Ø§Ø³Ø§Øª (Ø§ÙØµÙ„ Ø¨ÙŠÙ†Ù‡Ø§ Ø¨ÙØ§ØµÙ„Ø©)</label>
                                <input type="text" name="sizes" id="sizes" class="form-control rounded-3" placeholder="Ù…Ø«Ø§Ù„: 0-3M, 2Y, 3Y, 4Y" dir="ltr">
                            </div>

                            <div class="col-md-6">
                                <label class="form-label small fw-bold">Ø§Ù„Ø£Ù„ÙˆØ§Ù† (Ø§ÙØµÙ„ Ø¨ÙŠÙ†Ù‡Ø§ Ø¨ÙØ§ØµÙ„Ø©)</label>
                                <input type="text" name="colors" id="colors" class="form-control rounded-3" placeholder="Ø£Ø­Ù…Ø±, Ø£Ø²Ø±Ù‚, Ø£Ø¨ÙŠØ¶" dir="rtl">
                            </div>

                            <textarea name="description_en" id="description_en" class="d-none"></textarea>

                            <div class="col-md-12">
                                <label class="form-label small fw-bold text-muted">Ø§Ù„ÙˆØµÙ (Ø¹Ø±Ø¨ÙŠ)</label>
                                <textarea name="description_ar" id="description_ar" class="form-control rounded-3" rows="3"></textarea>
                            </div>

                            <div class="col-12">
                                <div class="p-3 bg-light rounded-3 border dashed-border">
                                    <label class="form-label small fw-bold d-block mb-3">ğŸ“¸ Ø±ÙØ¹ Ø§Ù„ØµÙˆØ± ÙˆØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø£ÙƒÙˆØ§Ø¯</label>
                                    
                                    <input type="file" name="images" id="imageFiles" class="form-control mb-3" multiple accept="image/*">
                                    
                                    <div id="previewContainer" class="d-flex gap-3 flex-wrap justify-content-center bg-white p-3 rounded shadow-sm" style="min-height: 100px;">
                                        <div class="text-muted small my-auto">Ø§Ù„ØµÙˆØ± Ø§Ù„Ù…Ø®ØªØ§Ø±Ø© Ø³ØªØ¸Ù‡Ø± Ù‡Ù†Ø§...</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="modal-footer bg-light border-0">
                        <button type="button" class="btn btn-secondary rounded-pill px-4" data-bs-dismiss="modal">Ø¥Ù„ØºØ§Ø¡</button>
                        <button type="submit" class="btn btn-primary rounded-pill px-5 fw-bold" id="saveBtn">Ø­ÙØ¸</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        const API_URL = '/api/products';
        const modal = new bootstrap.Modal(document.getElementById('productModal'));
        const ADMIN_TOKEN = localStorage.getItem('adminToken');
        let allProducts = [];

        fetchInventory();

        function handleLogout() {
            localStorage.removeItem('adminToken');
            window.location.href = 'login';
        }

        async function fetchInventory() {
            try {
                const res = await fetch(API_URL);
                allProducts = await res.json();
                renderInventory(allProducts);
            } catch (err) {
                document.getElementById('inventoryList').innerHTML = `<tr><td colspan="8" class="text-center text-danger">Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„</td></tr>`;
            }
        }

        // Helper to get image URL safely (handles old strings vs new objects)
        function getImageUrl(imgData) {
            if (!imgData) return 'assets/images/placeholder.png';
            const filename = (typeof imgData === 'string') ? imgData : imgData.url;
            return filename.startsWith('http') ? filename : `/uploads/${filename}`;
        }

        function renderInventory(products) {
            const tbody = document.getElementById('inventoryList');
            if(products.length === 0) {
                tbody.innerHTML = `<tr><td colspan="8" class="text-center py-5">Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© ÙØ§Ø±ØºØ©</td></tr>`;
                return;
            }

            const categoryMap = { 'boys': 'Ø£ÙˆÙ„Ø§Ø¯', 'girls': 'Ø¨Ù†Ø§Øª', 'newborn': 'Ù…ÙˆØ§Ù„ÙŠØ¯', 'all': 'Ø§Ù„ÙƒÙ„' };

            tbody.innerHTML = products.map(p => {
                // Safely get first image
                const firstImg = (p.images && p.images.length > 0) ? p.images[0] : null;
                const imgPath = getImageUrl(firstImg);

                const stockBtn = p.inStock 
                    ? `<button onclick="toggleStock('${p._id}')" class="btn btn-sm btn-success rounded-pill px-3 shadow-sm">âœ… Ù…ØªÙˆÙØ±</button>`
                    : `<button onclick="toggleStock('${p._id}')" class="btn btn-sm btn-danger rounded-pill px-3 shadow-sm">âŒ Ù†ÙØ¯</button>`;
                
                return `
                <tr>
                    <td class="pe-4"><img src="${imgPath}" class="product-img shadow-sm"></td>
                    <td class="small fw-bold text-muted">${p.itemId || '-'}</td>
                    <td><div class="fw-bold text-dark">${p.name_ar || '-'}</div></td>
                    <td class="fw-bold text-primary">â‚ª${p.price}</td>
                    <td>
                        <span class="badge bg-light text-dark border">${categoryMap[p.category] || p.category}</span>
                        <div class="small text-muted mt-1">${p.subCategory || '-'}</div>
                    </td>
                    <td>${stockBtn}</td>
                    <td class="text-end ps-4">
                        <button onclick="openEditModal('${p._id}')" class="btn btn-sm btn-primary px-3 rounded-pill me-1">ØªØ¹Ø¯ÙŠÙ„</button>
                        <button onclick="deleteProduct('${p._id}')" class="btn btn-sm btn-outline-danger px-3 rounded-pill">Ø­Ø°Ù</button>
                    </td>
                </tr>`;
            }).join('');
        }

        async function toggleStock(id) {
            try {
                await fetch(`${API_URL}/${id}/toggle`, { method: 'PUT', headers: { 'Authorization': ADMIN_TOKEN } });
                fetchInventory();
            } catch(e) { alert("Error"); }
        }

        document.getElementById('productForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = document.getElementById('saveBtn');
            btn.disabled = true;
            
            const formData = new FormData(e.target);
            const editId = document.getElementById('editId').value;
            
            if (!formData.get('name_en')) formData.set('name_en', formData.get('name_ar')); 
            if (!formData.get('description_en')) formData.set('description_en', formData.get('description_ar')); 

            const url = editId ? `${API_URL}/${editId}` : API_URL;
            const method = editId ? 'PUT' : 'POST';

            try {
                const res = await fetch(url, { 
                    method: method, 
                    headers: { 'Authorization': ADMIN_TOKEN },
                    body: formData 
                });
                if (res.ok) {
                    modal.hide();
                    fetchInventory();
                } else { alert("ÙØ´Ù„ Ø§Ù„Ø­ÙØ¸"); }
            } catch (err) { alert("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø®Ø§Ø¯Ù…"); } 
            finally { btn.disabled = false; }
        });

        window.openEditModal = function(id) {
            const p = allProducts.find(x => x._id === id);
            if(!p) return;

            document.getElementById('modalTitle').innerText = "ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬";
            document.getElementById('editId').value = p._id;
            document.getElementById('itemId').value = p.itemId || ''; 
            document.getElementById('name_ar').value = p.name_ar || '';
            document.getElementById('price').value = p.price;
            document.getElementById('oldPrice').value = p.oldPrice || '';
            document.getElementById('category').value = p.category;
            document.getElementById('subCategory').value = p.subCategory || 'other'; // Set SubCategory
            document.getElementById('inStock').value = p.inStock;
            document.getElementById('sizes').value = p.sizes ? p.sizes.join(', ') : '';
            document.getElementById('colors').value = p.colors ? p.colors.join(', ') : ''; 
            document.getElementById('description_ar').value = p.description_ar || '';
            
            // Clear previews since we don't support editing specific image codes easily yet
            // Just show a message
            document.getElementById('previewContainer').innerHTML = '<div class="alert alert-info w-100 text-center small">Ù„ØªØºÙŠÙŠØ± Ø§Ù„ØµÙˆØ± Ø£Ùˆ Ø§Ù„Ø£ÙƒÙˆØ§Ø¯ØŒ ÙŠØ±Ø¬Ù‰ Ø¥Ø¹Ø§Ø¯Ø© Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±. Ø§Ù„ØµÙˆØ± Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ù…Ø­ÙÙˆØ¸Ø© Ø¥Ø°Ø§ Ù„Ù… ØªÙ‚Ù… Ø¨Ø±ÙØ¹ ØµÙˆØ± Ø¬Ø¯ÙŠØ¯Ø©.</div>';
            
            modal.show();
        }

        window.openAddModal = function() {
            document.getElementById('productForm').reset();
            document.getElementById('modalTitle').innerText = "Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬ Ø¬Ø¯ÙŠØ¯";
            document.getElementById('editId').value = ""; 
            document.getElementById('previewContainer').innerHTML = '<div class="text-muted small my-auto">Ø§Ù„ØµÙˆØ± Ø§Ù„Ù…Ø®ØªØ§Ø±Ø© Ø³ØªØ¸Ù‡Ø± Ù‡Ù†Ø§...</div>';
            modal.show();
        }

        async function deleteProduct(id) {
            if (!confirm("Ø­Ø°Ù Ø§Ù„Ù…Ù†ØªØ¬ØŸ")) return;
            try {
                const res = await fetch(`${API_URL}/${id}`, { method: 'DELETE', headers: { 'Authorization': ADMIN_TOKEN } });
                if (res.ok) fetchInventory();
            } catch(e) {}
        }

        // NEW: Enhanced Image Preview with Code Inputs
        document.getElementById('imageFiles').addEventListener('change', function(e) {
            const container = document.getElementById('previewContainer');
            container.innerHTML = ''; // Clear previous

            if (this.files.length === 0) return;

            Array.from(this.files).forEach((file, index) => {
                const reader = new FileReader();
                reader.onload = function(ev) {
                    // Create wrapper for image + input
                    const wrapper = document.createElement('div');
                    wrapper.className = "preview-wrapper d-flex flex-column gap-2 p-2 border rounded bg-light";
                    wrapper.style.width = "120px";

                    const img = document.createElement('img');
                    img.src = ev.target.result;
                    img.className = "rounded shadow-sm";
                    img.style.width = "100%";
                    img.style.height = "100px";
                    img.style.objectFit = "cover";

                    const input = document.createElement('input');
                    input.type = "text";
                    input.name = "imageCodes"; // IMPORTANT: All these inputs have same name
                    input.className = "form-control form-control-sm text-center fw-bold";
                    input.placeholder = "ÙƒÙˆØ¯ (Ù…Ø«Ù„Ø§Ù‹: Red)";
                    input.required = true;

                    wrapper.appendChild(img);
                    wrapper.appendChild(input);
                    container.appendChild(wrapper);
                }
                reader.readAsDataURL(file);
            });
        });
    </script>
</body>

</html>
